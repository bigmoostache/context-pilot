name: PR Cleanup

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
    steps:
      - name: Close linked issues and delete branch
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Find linked issues from PR body ("Closes #N", "Fixes #N", "Resolves #N")
            const body = pr.body || '';
            const pattern = /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+#(\d+)/gi;
            const issueNumbers = new Set();
            let match;
            while ((match = pattern.exec(body)) !== null) {
              issueNumbers.add(parseInt(match[1]));
            }

            // Close each linked issue
            for (const issueNumber of issueNumbers) {
              try {
                await github.rest.issues.update({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  state: 'closed',
                });
                console.log(`Closed issue #${issueNumber}`);
              } catch (e) {
                console.log(`Failed to close issue #${issueNumber}: ${e.message}`);
              }
            }

            // Delete the head branch (skip if from a fork)
            if (!pr.head.repo.fork) {
              const branch = pr.head.ref;
              try {
                await github.rest.git.deleteRef({
                  owner,
                  repo,
                  ref: `heads/${branch}`,
                });
                console.log(`Deleted branch ${branch}`);
              } catch (e) {
                console.log(`Failed to delete branch ${branch}: ${e.message}`);
              }
            }
